# 协同诊疗功能说明文档

## 功能概述

协同诊疗功能允许医生之间进行跨医院的协作诊疗。医生可以通过患者的HashID直接查看患者信息，并向其他医院的医生发起协同诊疗请求。被邀请的医生可以查看患者信息并提供诊疗意见，发起请求的医生可以查看所有医院医生提供的诊疗意见。

## 主要变更

### 1. 数据模型变更

#### 新增数据表

-**collaboration_request**：协同诊疗请求表

- 存储医生发起的协同诊疗请求信息
- 包含发起医生、患者、目标医院等信息

-**diagnosis_opinion**：诊疗意见表

- 存储各医院医生提供的诊疗意见
- 包含诊断结果、治疗建议等内容

### 2. 后端API变更

#### 新增API端点

1.`POST /api/create-collaboration-request` - 创建协同诊疗请求

2.`GET /api/get-collaboration-requests-by-doctor` - 获取医生发起的协同诊疗请求

3.`GET /api/get-collaboration-requests-by-hospital` - 获取针对某医院的协同诊疗请求

4.`GET /api/get-collaboration-request` - 获取单个协同诊疗请求详情

5.`POST /api/update-collaboration-request-status` - 更新协同诊疗请求状态

6.`POST /api/submit-diagnosis-opinion` - 提交诊疗意见

7.`GET /api/get-diagnosis-opinions-by-request` - 获取协同诊疗请求的所有诊疗意见

8.`GET /api/get-diagnosis-opinion-by-doctor` - 获取医生在某个请求中的诊疗意见

#### 新增文件

-`/object/collaboration_request.go` - 协同诊疗请求数据模型

-`/object/diagnosis_opinion.go` - 诊疗意见数据模型

-`/controllers/collaboration.go` - 协同诊疗API控制器

### 3. 前端功能变更

#### 移除的功能

- 患者授权审批流程（患者界面）
- 医生向患者发起授权请求的功能
- 患者授权历史记录查看

#### 新增的功能

1.**患者信息直接查询**

- 医生可以通过患者HashID直接查询并查看患者就诊记录
- 无需患者授权即可查看

2.**发起协同诊疗请求**

- 查询到患者信息后，医生可以选择目标医院发起协同诊疗请求
- 可选择的医院：广东省人民医院、中国医科大学第一附属医院
- 可填写协同诊疗说明

3.**查看我发起的协同诊疗请求**

- 医生可以查看自己发起的所有协同诊疗请求
- 可以查看每个请求的详细信息
- 可以查看各医院医生提供的诊疗意见

4.**处理待我处理的协同诊疗请求**

- 医生可以查看其他医院医生发起的、针对本医院的协同诊疗请求
- 可以查看患者信息
- 可以填写并提交诊疗意见

5.**诊疗意见管理**

- 医生可以填写诊疗意见、诊断结果、治疗建议
- 可以更新已提交的诊疗意见
- 发起医生可以查看所有参与医生的诊疗意见汇总

## 部署步骤

### 1. 数据库迁移

执行SQL脚本创建新的数据表：

```bash

mysql-uyour_username-pyour_database < sql/create_collaboration_tables.sql

```

### 2. 后端编译和部署

```bash

cd/home/baec/casibase-med

gobuild

./casibase

```

### 3. 前端重启（如果需要）

前端代码已经修改，如果使用热重载则自动生效，否则需要重启前端服务。

## 使用流程

### 医生A（发起协同诊疗）

1. 登录系统（需要tag为'doctor'，且affiliation字段填写了医院名称）
2. 在"患者信息查询与协同诊疗"卡片中输入患者HashID
3. 点击"查询"按钮，系统会显示患者的就诊记录
4. 选择需要协作的医院（可多选）
5. 填写协同诊疗说明（可选）
6. 点击"发起协同诊疗请求"
7. 在"我发起的协同诊疗请求"中查看请求状态
8. 点击"查看意见"可以查看其他医院医生提供的诊疗意见

### 医生B（参与协同诊疗）

1. 登录系统（affiliation字段需要匹配被邀请的医院名称）
2. 在"待我处理的协同诊疗请求"中查看收到的协同诊疗请求
3. 点击"查看详情"了解请求信息
4. 点击"填写意见"打开诊疗意见表单
5. 填写诊疗意见（必填）、诊断结果（可选）、治疗建议（可选）
6. 点击"提交"按钮提交诊疗意见
7. 如需修改，可以重新点击"填写意见"，系统会加载之前提交的内容

## 用户字段要求

为了正确使用协同诊疗功能，用户（医生）需要在Casdoor中配置以下字段：

-`tag`: 设置为 'doctor'

-`affiliation`: 设置为医生所在医院的名称（必须与协同诊疗请求中的医院名称完全匹配）

- 例如：广东省人民医院
- 例如：中国医科大学第一附属医院

## 注意事项

1.**医院名称匹配**：医生的 `affiliation` 字段必须与可选医院列表中的名称完全一致

2.**患者信息保护**：虽然移除了患者授权流程，但系统仍应通过其他机制保护患者隐私

3.**诊疗意见唯一性**：每个医生对同一个协同诊疗请求只能提交一个诊疗意见，但可以更新

4.**请求状态管理**：协同诊疗请求有三种状态：

- active：进行中
- completed：已完成
- cancelled：已取消

## 技术架构

### 后端技术栈

- Go (Beego框架)
- XORM (ORM)
- MySQL数据库

### 前端技术栈

- React
- Ant Design
- ECharts（图表展示）

## 未来扩展

1. 支持更多医院
2. 添加消息通知功能
3. 支持附件上传（影像资料等）
4. 添加诊疗意见讨论功能
5. 统计分析功能

## 问题排查

### 问题1：查不到患者信息

- 检查患者HashID是否正确
- 检查数据库中是否有该患者的就诊记录

### 问题2：看不到待处理的协同诊疗请求

- 检查用户的 `affiliation` 字段是否设置正确
- 检查 `affiliation` 字段是否与请求中的目标医院名称完全匹配

### 问题3：无法提交诊疗意见

- 检查诊疗意见（必填项）是否已填写
- 检查网络连接
- 查看浏览器控制台是否有错误信息

## 联系方式

如有问题，请联系开发团队。
